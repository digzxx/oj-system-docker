server {
    listen 80;
    server_name localhost;

    # 1. API 代理：将所有 /api 请求转发给 Django 后端服务
    location /api/ {
        # 转发到 Docker Compose 中定义的后端服务名 'backend'
        proxy_pass http://backend:8000/api/; 
        
        # 传递客户端真实的 IP 和 Host 头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. 前端代理：将所有其他请求转发给 Vite Dev Server (frontend:5173)
    location / {
        # 转发到 Vite 开发服务器
        proxy_pass http://frontend:5173; 
        
        # 传递 Host 头
        proxy_set_header Host $host;

        # === 关键：WebSocket 支持 (解决 HMR 连接失败) ===
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # ============================================

        # **[移除 try_files]**
        # 移除 try_files，让所有请求都无条件转发给 Vite，由 Vite 处理 404/路由。
        # 这样可以避免 Nginx 在转发前在自己的文件系统中查找文件。
    }

    # **[新增]** 如果 Nginx 无法连接到任一上游服务，直接返回 502 Bad Gateway
    # 这样我们可以区分是 Nginx 自身配置错误 (500) 还是上游服务不可达 (502)。
    error_page 502 = @fallback_502;
    location @fallback_502 {
        default_type text/plain;
        return 502 "Error: Backend or Frontend service is unreachable.";
    }


}